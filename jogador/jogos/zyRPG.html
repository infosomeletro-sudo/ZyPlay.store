<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ZyRPG — Reino de Zyland</title>
  <style>
    :root{
      --bg:#0b0b14; --panel:#111125; --panel2:#151530; --line:#2a2a5a;
      --txt:#e8e8ff; --muted:#a9a9d6; --accent:#7b00ff; --accent2:#00e0ff;
      --good:#2be37a; --bad:#ff4d6d; --warn:#ffd166;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 50% -20%, #25104d, var(--bg)); color:var(--txt); font-family:system-ui,Segoe UI,Arial; overflow:hidden}
    #wrap{display:grid; grid-template-columns: 1fr 360px; gap:14px; padding:14px; height:100vh}
    #game{
      background:linear-gradient(180deg,#0e0e20,#080813);
      border:1px solid var(--line); border-radius:16px; position:relative; overflow:hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      min-height: 520px;
    }
    canvas{width:100%;height:100%;display:block}
    #hudRight{
      background:linear-gradient(180deg,var(--panel),#0d0d1c);
      border:1px solid var(--line); border-radius:16px; padding:14px;
      display:flex; flex-direction:column; gap:12px;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
    }
    .card{background:linear-gradient(180deg,var(--panel2),#0f0f22); border:1px solid var(--line); border-radius:14px; padding:12px}
    .row{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px; border-radius:999px; background:#0c0c1a; border:1px solid var(--line);
      color:var(--muted); font-size:12px;
    }
    .bar{height:10px;border-radius:999px;background:#0a0a15;border:1px solid var(--line); overflow:hidden}
    .bar > i{display:block;height:100%; width:50%}
    .hp i{background:linear-gradient(90deg,#ff4d6d,#ff8aa0)}
    .mp i{background:linear-gradient(90deg,#00e0ff,#7b00ff)}
    .xp i{background:linear-gradient(90deg,#ffd166,#2be37a)}
    h2{margin:0 0 6px; font-size:16px}
    .small{color:var(--muted); font-size:12px; line-height:1.35}
    .btns{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    button{
      cursor:pointer; border:1px solid var(--line); border-radius:12px; padding:10px 10px;
      background:linear-gradient(180deg,#15153b,#0e0e23);
      color:var(--txt); font-weight:650;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      transition:transform .08s ease, filter .08s ease;
    }
    button:hover{filter:brightness(1.12)}
    button:active{transform:translateY(1px) scale(.99)}
    button.primary{border-color:rgba(123,0,255,.6); box-shadow: 0 0 0 2px rgba(123,0,255,.12), 0 10px 30px rgba(0,0,0,.35)}
    button.good{border-color:rgba(43,227,122,.55)}
    button.bad{border-color:rgba(255,77,109,.55)}
    button:disabled{opacity:.55; cursor:not-allowed}

    #toast{
      position:absolute; left:14px; bottom:14px; max-width:min(520px,calc(100% - 28px));
      background:rgba(10,10,20,.85); border:1px solid var(--line); border-radius:14px; padding:10px 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
      display:flex; gap:10px; align-items:flex-start;
    }
    #toast b{color:#fff}
    #toast .t{font-size:13px; line-height:1.35; color:var(--txt)}
    #toast .k{color:var(--muted); font-size:12px}

    /* Modal */
    #modal{
      position:absolute; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55);
    }
    #modal .box{
      width:min(760px, calc(100% - 28px));
      max-height: calc(100% - 28px);
      overflow:auto;
      background:linear-gradient(180deg,#141436,#0b0b18);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: 0 30px 100px rgba(0,0,0,.65);
      padding:14px;
    }
    #modal .title{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
    #modal .title h3{margin:0;font-size:16px}
    #modal .grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .item{
      border:1px solid var(--line);
      background:linear-gradient(180deg,#121232,#0d0d1f);
      border-radius:14px;
      padding:10px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .item .name{font-weight:750}
    .item .desc{font-size:12px; color:var(--muted); margin-top:4px; line-height:1.3}
    .tag{font-size:11px; color:var(--muted); border:1px solid var(--line); padding:3px 7px; border-radius:999px}
    .right{display:flex; flex-direction:column; gap:8px; align-items:flex-end}
    .money{color:var(--warn); font-weight:800}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .sep{height:1px;background:var(--line); margin:10px 0}

    /* Battle panel inside right side */
    #battleCard{display:none}
    #battleLog{height:120px; overflow:auto; font-size:12px; color:var(--muted); line-height:1.35}
    #battleLog div{margin:0 0 6px}
    #enemyLine{display:flex; align-items:center; justify-content:space-between; gap:10px}
    #enemyName{font-weight:800}
    #enemyHP{font-weight:750; color:#ffd166}
    #hint{font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
<div id="wrap">
  <div id="game">
    <canvas id="c"></canvas>

    <div id="toast">
      <div>
        <div class="t"><b>ZyRPG</b> — Explore o mundo, faça missões e lute!</div>
        <div class="k">Mover: WASD/Setas • Interagir: E/Enter • Menu: botões à direita • Esc fecha janelas</div>
      </div>
    </div>

    <div id="modal">
      <div class="box">
        <div class="title">
          <h3 id="modalTitle">Menu</h3>
          <button id="closeModal">Fechar (Esc)</button>
        </div>
        <div id="modalBody"></div>
      </div>
    </div>
  </div>

  <aside id="hudRight">
    <div class="card">
      <div class="row">
        <h2 id="pName">Herói</h2>
        <span class="pill"><span>Lv</span> <b id="pLv">1</b></span>
      </div>
      <div class="small" id="pClass">Classe: Aventureiro • Região: Zyland</div>
      <div class="sep"></div>

      <div class="row"><span class="small">HP</span><span class="small mono"><b id="pHpTxt">30</b>/<span id="pHpMax">30</span></span></div>
      <div class="bar hp"><i id="hpBar"></i></div>

      <div style="height:8px"></div>

      <div class="row"><span class="small">MP</span><span class="small mono"><b id="pMpTxt">10</b>/<span id="pMpMax">10</span></span></div>
      <div class="bar mp"><i id="mpBar"></i></div>

      <div style="height:8px"></div>

      <div class="row"><span class="small">XP</span><span class="small mono"><b id="pXpTxt">0</b>/<span id="pXpNeed">20</span></span></div>
      <div class="bar xp"><i id="xpBar"></i></div>

      <div style="height:10px"></div>
      <div class="row">
        <span class="pill">Ouro: <b class="money" id="pGold">25</b></span>
        <span class="pill">Poções: <b id="pPot">1</b></span>
      </div>

      <div style="height:10px"></div>
      <div id="hint">Dica: fale com o Ancião na vila para começar a missão.</div>
    </div>

    <div class="card btns">
      <button class="primary" id="btnInv">Inventário</button>
      <button id="btnQuests">Missões</button>
      <button id="btnShop">Loja</button>
      <button id="btnHelp">Ajuda</button>
      <button class="good" id="btnSave">Salvar</button>
      <button class="bad" id="btnReset">Reset</button>
    </div>

    <div class="card" id="battleCard">
      <div id="enemyLine">
        <div>
          <div id="enemyName">Inimigo</div>
          <div class="small" id="enemyDesc">...</div>
        </div>
        <div id="enemyHP">HP: 10</div>
      </div>
      <div class="sep"></div>

      <div class="btns">
        <button class="primary" id="bAttack">Atacar</button>
        <button id="bSkill">Habilidade</button>
        <button id="bItem">Item</button>
        <button class="bad" id="bRun">Fugir</button>
      </div>

      <div class="sep"></div>
      <div id="battleLog"></div>
    </div>

    <div class="card small">
      <b>Objetivo atual:</b>
      <div id="objective" class="small">Encontre o Ancião na vila (ícone ✦) e fale com ele (E).</div>
      <div class="sep"></div>
      <div class="small">Versão: <span class="mono">ZyRPG 1.0</span> • Tudo offline • Som por WebAudio</div>
    </div>
  </aside>
</div>

<script>
(() => {
  // =========================
  // Util / Audio (sem mp3)
  // =========================
  const AudioFX = (() => {
    let ctx = null;
    let enabled = true;
    function ensure(){
      if(!ctx){
        const AC = window.AudioContext || window.webkitAudioContext;
        ctx = new AC();
      }
      if(ctx.state === "suspended") ctx.resume();
      return ctx;
    }
    function beep({freq=440, type="sine", dur=0.08, gain=0.08}={}){
      if(!enabled) return;
      const c = ensure();
      const o = c.createOscillator();
      const g = c.createGain();
      o.type = type;
      o.frequency.value = freq;
      g.gain.value = 0.0001;
      o.connect(g); g.connect(c.destination);
      const t = c.currentTime;
      g.gain.exponentialRampToValueAtTime(gain, t + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
      o.start(t); o.stop(t + dur + 0.02);
    }
    function click(){ beep({freq:820,type:"square",dur:0.04,gain:0.04}); }
    function step(){ beep({freq:160,type:"triangle",dur:0.03,gain:0.02}); }
    function hit(){ beep({freq:120,type:"sawtooth",dur:0.08,gain:0.06}); }
    function heal(){ beep({freq:520,type:"sine",dur:0.12,gain:0.06}); beep({freq:780,type:"sine",dur:0.10,gain:0.05}); }
    function win(){ beep({freq:523,type:"sine",dur:0.10,gain:0.06}); beep({freq:659,type:"sine",dur:0.10,gain:0.06}); beep({freq:784,type:"sine",dur:0.12,gain:0.07}); }
    function lose(){ beep({freq:220,type:"sine",dur:0.12,gain:0.05}); beep({freq:196,type:"sine",dur:0.16,gain:0.05}); }
    function toggle(v){ enabled = v; }
    return {click,step,hit,heal,win,lose,toggle,ensure};
  })();

  // Ativar áudio no 1º input (restrição do navegador)
  const primeAudio = () => { AudioFX.ensure(); window.removeEventListener("pointerdown", primeAudio); window.removeEventListener("keydown", primeAudio); };
  window.addEventListener("pointerdown", primeAudio, {once:true});
  window.addEventListener("keydown", primeAudio, {once:true});

  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
  const rand = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];

  // =========================
  // Canvas / World
  // =========================
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  function resize(){
    const r = canvas.getBoundingClientRect();
    canvas.width = Math.floor(r.width * devicePixelRatio);
    canvas.height = Math.floor(r.height * devicePixelRatio);
  }
  window.addEventListener("resize", resize);
  resize();

  // Mapa: 0=grama, 1=parede/rocha, 2=agua, 3=areia, 4=chao vila
  const TILE = 32;
  const W = 30, H = 18; // base lógica
  const world = {
    tiles: [],
    // áreas: vila (centro), floresta (lado), lago, montanhas
    init(){
      const t = new Array(W*H).fill(0);
      // bordas rocha
      for(let x=0;x<W;x++){ t[x]=1; t[x+(H-1)*W]=1; }
      for(let y=0;y<H;y++){ t[0+y*W]=1; t[(W-1)+y*W]=1; }

      // lago
      for(let y=3;y<=7;y++){
        for(let x=20;x<=26;x++){
          t[x+y*W]=2;
        }
      }
      // praia perto do lago
      for(let y=2;y<=8;y++){
        for(let x=19;x<=27;x++){
          if(t[x+y*W]===0 && Math.random()<0.22) t[x+y*W]=3;
        }
      }

      // montanhas (rocha)
      for(let y=2;y<=6;y++){
        for(let x=3;x<=8;x++){
          if(Math.random()<0.45) t[x+y*W]=1;
        }
      }

      // vila chão
      const vx1=10, vx2=17, vy1=9, vy2=14;
      for(let y=vy1;y<=vy2;y++){
        for(let x=vx1;x<=vx2;x++){
          t[x+y*W]=4;
        }
      }
      // caminhos
      for(let x=10;x<=17;x++) t[x+8*W]=4;
      for(let y=8;y<=14;y++) t[9+y*W]=4;

      // casa/obstáculos simples dentro da vila
      const blocks = [
        {x:12,y:10,w:2,h:2},{x:15,y:12,w:2,h:2},{x:11,y:13,w:1,h:1}
      ];
      for(const b of blocks){
        for(let yy=b.y; yy<b.y+b.h; yy++){
          for(let xx=b.x; xx<b.x+b.w; xx++){
            t[xx+yy*W]=1;
          }
        }
      }

      this.tiles = t;
    },
    solid(x,y){
      const v = this.tiles[x+y*W];
      return v===1 || v===2; // rocha ou agua bloqueia
    },
    tile(x,y){ return this.tiles[x+y*W]; }
  };
  world.init();

  // NPCs / Pontos
  const NPCS = [
    { id:"elder", name:"Ancião Lys", x:13, y:9, icon:"✦", talk: elderDialog },
    { id:"merchant", name:"Mercadora Nia", x:16, y:14, icon:"$", talk: merchantDialog },
  ];

  // =========================
  // Estado do Jogo
  // =========================
  const defaultState = () => ({
    player: {
      name:"Herói", cls:"Aventureiro",
      x: 11, y: 13,
      lv:1, xp:0, xpNeed:20,
      hp:30, hpMax:30,
      mp:10, mpMax:10,
      atk:6, def:2,
      gold:25,
      inv: { potion: 1, ether: 0, bomb: 0 },
      flags: { metElder:false, questWolf:false, questWolfDone:false },
    },
    battle: null,
    steps: 0,
    msg: "Bem-vindo a Zyland! Ande pela vila e fale com o Ancião (✦)."
  });

  let state = load() ?? defaultState();

  // =========================
  // UI refs
  // =========================
  const ui = {
    pName: document.getElementById("pName"),
    pClass: document.getElementById("pClass"),
    pLv: document.getElementById("pLv"),
    pHpTxt: document.getElementById("pHpTxt"),
    pHpMax: document.getElementById("pHpMax"),
    pMpTxt: document.getElementById("pMpTxt"),
    pMpMax: document.getElementById("pMpMax"),
    pXpTxt: document.getElementById("pXpTxt"),
    pXpNeed: document.getElementById("pXpNeed"),
    pGold: document.getElementById("pGold"),
    pPot: document.getElementById("pPot"),
    hpBar: document.getElementById("hpBar"),
    mpBar: document.getElementById("mpBar"),
    xpBar: document.getElementById("xpBar"),
    hint: document.getElementById("hint"),
    objective: document.getElementById("objective"),
    toast: document.getElementById("toast"),
    modal: document.getElementById("modal"),
    modalTitle: document.getElementById("modalTitle"),
    modalBody: document.getElementById("modalBody"),
    closeModal: document.getElementById("closeModal"),
    battleCard: document.getElementById("battleCard"),
    enemyName: document.getElementById("enemyName"),
    enemyDesc: document.getElementById("enemyDesc"),
    enemyHP: document.getElementById("enemyHP"),
    battleLog: document.getElementById("battleLog"),
    bAttack: document.getElementById("bAttack"),
    bSkill: document.getElementById("bSkill"),
    bItem: document.getElementById("bItem"),
    bRun: document.getElementById("bRun"),
    btnInv: document.getElementById("btnInv"),
    btnQuests: document.getElementById("btnQuests"),
    btnShop: document.getElementById("btnShop"),
    btnHelp: document.getElementById("btnHelp"),
    btnSave: document.getElementById("btnSave"),
    btnReset: document.getElementById("btnReset"),
  };

  function toast(text){
    state.msg = text;
    ui.toast.querySelector(".t").innerHTML = `<b>ZyRPG</b> — ${escapeHtml(text)}`;
  }
  function escapeHtml(s){
    return (s+"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // =========================
  // Modal
  // =========================
  function openModal(title, html){
    ui.modalTitle.textContent = title;
    ui.modalBody.innerHTML = html;
    ui.modal.style.display = "flex";
  }
  function closeModal(){
    ui.modal.style.display = "none";
  }
  ui.closeModal.onclick = () => { AudioFX.click(); closeModal(); };
  window.addEventListener("keydown", (e)=>{
    if(e.key==="Escape"){ closeModal(); }
  });

  // =========================
  // Menus
  // =========================
  ui.btnInv.onclick = () => { AudioFX.click(); showInventory(); };
  ui.btnQuests.onclick = () => { AudioFX.click(); showQuests(); };
  ui.btnShop.onclick = () => { AudioFX.click(); showShop(); };
  ui.btnHelp.onclick = () => { AudioFX.click(); showHelp(); };
  ui.btnSave.onclick = () => { AudioFX.click(); save(); toast("Jogo salvo!"); };
  ui.btnReset.onclick = () => {
    AudioFX.click();
    if(confirm("Resetar o jogo? Você vai perder o progresso.")){
      state = defaultState();
      save();
      toast("Novo jogo iniciado.");
    }
  };

  function showInventory(){
    const p = state.player;
    const inv = p.inv;
    openModal("Inventário", `
      <div class="small">Use itens fora do combate também.</div>
      <div class="sep"></div>
      <div class="grid">
        ${invCard("Poção", "potion", inv.potion, "Cura 15 HP.", "CURA", () => useItem("potion"))}
        ${invCard("Éter", "ether", inv.ether, "Recupera 8 MP.", "MANA", () => useItem("ether"))}
        ${invCard("Bomba", "bomb", inv.bomb, "Dano 12 ao inimigo (só no combate).", "ATAQUE", () => useItem("bomb"))}
        ${invCard("Mapa", "map", 1, "Mostra áreas e dicas.", "INFO", () => showMap())}
      </div>
    `);
    attachInvButtons();
  }

  function invCard(name, key, qty, desc, tag, onUse){
    const disabled = qty<=0 && key!=="map";
    return `
      <div class="item">
        <div>
          <div class="name">${name} <span class="tag">${tag}</span></div>
          <div class="desc">${desc}</div>
          <div class="desc">Quantidade: <b>${qty}</b></div>
        </div>
        <div class="right">
          <button data-use="${key}" ${disabled?"disabled":""}>Usar</button>
        </div>
      </div>
    `;
  }
  function attachInvButtons(){
    ui.modalBody.querySelectorAll("button[data-use]").forEach(btn=>{
      btn.onclick = () => {
        AudioFX.click();
        const key = btn.getAttribute("data-use");
        if(key==="map"){ showMap(); return; }
        useItem(key);
        // refresh
        showInventory();
      };
    });
  }

  function showMap(){
    const p = state.player;
    openModal("Mapa de Zyland", `
      <div class="small">Você está em <b>(${p.x}, ${p.y})</b>. Vila fica no centro. Lago fica a leste. Montanhas a oeste.</div>
      <div class="sep"></div>
      <div class="small">
        <b>Locais:</b><br/>
        • Vila (chão claro): NPCs ✦ (Ancião) e $ (Mercadora)<br/>
        • Floresta (grama): encontros com monstros<br/>
        • Lago (água): bloqueado<br/>
        • Montanhas (rochas): bloqueado
      </div>
    `);
  }

  function showQuests(){
    const f = state.player.flags;
    let q1 = !f.metElder ? "Fale com o Ancião Lys (✦) na vila." :
             !f.questWolf ? "Missão: Ajude Zyland — aceite a missão do Ancião." :
             !f.questWolfDone ? "Derrote 3 Lobos Sombrios na floresta. (Progresso: " + (f.wolfKills||0) + "/3)" :
             "Missão concluída: Lobos Sombrios derrotados! Volte ao Ancião.";

    openModal("Missões", `
      <div class="item">
        <div>
          <div class="name">Ajudar Zyland</div>
          <div class="desc">${q1}</div>
        </div>
        <div class="right"><span class="tag">Principal</span></div>
      </div>

      <div class="sep"></div>

      <div class="small">
        Recompensas aumentam seu ouro, XP e itens. Explore para encontrar mais inimigos.
      </div>
    `);
  }

  function showShop(){
    openModal("Loja da Mercadora", `
      <div class="small">Compre itens para facilitar as batalhas.</div>
      <div class="sep"></div>
      <div class="grid">
        ${shopCard("Poção", "potion", 12, "Cura 15 HP.", "CURA")}
        ${shopCard("Éter", "ether", 15, "Recupera 8 MP.", "MANA")}
        ${shopCard("Bomba", "bomb", 18, "Dano 12 (combate).", "ATAQUE")}
        ${shopCard("Amuleto", "amulet", 40, "Aumenta HP Máx +10 (1x).", "RARO")}
      </div>
      <div class="sep"></div>
      <div class="small">Seu ouro: <b class="money">${state.player.gold}</b></div>
    `);
    ui.modalBody.querySelectorAll("button[data-buy]").forEach(btn=>{
      btn.onclick = () => {
        AudioFX.click();
        buy(btn.getAttribute("data-buy"));
        showShop();
      };
    });
  }

  function shopCard(name, key, price, desc, tag){
    const affordable = state.player.gold >= price;
    return `
      <div class="item">
        <div>
          <div class="name">${name} <span class="tag">${tag}</span></div>
          <div class="desc">${desc}</div>
          <div class="desc">Preço: <b class="money">${price}</b></div>
        </div>
        <div class="right">
          <button data-buy="${key}" ${affordable?"":"disabled"}>Comprar</button>
        </div>
      </div>
    `;
  }

  function showHelp(){
    openModal("Ajuda", `
      <div class="small">
        <b>Controles</b><br/>
        • Mover: WASD ou Setas<br/>
        • Interagir: E ou Enter<br/>
        • Esc: Fechar janelas<br/><br/>
        <b>Combate</b><br/>
        • Atacar: dano base + variação<br/>
        • Habilidade: usa MP e dá dano maior<br/>
        • Item: Poção/Éter/Bomba<br/>
        • Fugir: chance de escapar (não garantido)
      </div>
      <div class="sep"></div>
      <div class="small">
        <b>Som</b>: é gerado pelo jogo (WebAudio). Se o som não tocar, clique na tela uma vez.
      </div>
    `);
  }

  // =========================
  // Compra / Itens
  // =========================
  function buy(key){
    const p = state.player;
    const prices = { potion:12, ether:15, bomb:18, amulet:40 };
    const price = prices[key];
    if(p.gold < price) return;

    p.gold -= price;
    if(key==="amulet"){
      if(p.flags.amuletBought) { p.gold += price; return; }
      p.flags.amuletBought = true;
      p.hpMax += 10;
      p.hp += 10;
      toast("Você comprou um Amuleto! HP Máx +10.");
      AudioFX.heal();
    }else{
      p.inv[key] = (p.inv[key]||0) + 1;
      toast(`Comprado: ${key.toUpperCase()}!`);
      AudioFX.click();
    }
    updateUI();
    save();
  }

  function useItem(key){
    const p = state.player;
    if(key==="potion"){
      if(p.inv.potion<=0) return;
      p.inv.potion--;
      const before = p.hp;
      p.hp = clamp(p.hp + 15, 0, p.hpMax);
      AudioFX.heal();
      toast(`Você usou Poção (+${p.hp - before} HP).`);
    }
    if(key==="ether"){
      if(p.inv.ether<=0) return;
      p.inv.ether--;
      const before = p.mp;
      p.mp = clamp(p.mp + 8, 0, p.mpMax);
      AudioFX.heal();
      toast(`Você usou Éter (+${p.mp - before} MP).`);
    }
    if(key==="bomb"){
      if(!state.battle){ toast("Bomba só pode ser usada no combate."); return; }
      if(p.inv.bomb<=0) return;
      p.inv.bomb--;
      const b = state.battle;
      const dmg = 12;
      b.enemy.hp = clamp(b.enemy.hp - dmg, 0, b.enemy.hpMax);
      AudioFX.hit();
      log(`Você arremessou uma Bomba! -${dmg} HP no inimigo.`);
      checkBattleEndOrEnemyTurn();
    }
    updateUI();
    save();
  }

  // =========================
  // NPC diálogos
  // =========================
  function elderDialog(){
    const p = state.player;
    const f = p.flags;

    if(!f.metElder){
      f.metElder = true;
      toast("Ancião Lys: 'Bem-vindo, jovem herói. Zyland precisa de você.'");
      ui.objective.textContent = "Aceite a missão do Ancião: Derrote Lobos Sombrios na floresta.";
      ui.hint.textContent = "Vá para a grama fora da vila para encontrar Lobos Sombrios.";
      return;
    }
    if(!f.questWolf){
      f.questWolf = true;
      f.wolfKills = 0;
      toast("Missão aceita: 'Derrote 3 Lobos Sombrios e traga paz à floresta.'");
      ui.objective.textContent = "Derrote 3 Lobos Sombrios (0/3) e depois volte ao Ancião.";
      return;
    }
    if(f.questWolf && !f.questWolfDone){
      toast(`Ancião Lys: 'Continue!' Progresso: ${f.wolfKills||0}/3`);
      return;
    }
    if(f.questWolfDone && !f.questRewarded){
      f.questRewarded = true;
      const rewardGold = 40, rewardXp = 30;
      p.gold += rewardGold;
      gainXP(rewardXp);
      p.inv.potion += 1;
      toast(`Ancião Lys: 'Excelente!' Recompensa: +${rewardGold} ouro, +${rewardXp} XP, +1 Poção.`);
      AudioFX.win();
      ui.objective.textContent = "Explore Zyland! Você pode evoluir e juntar ouro.";
      ui.hint.textContent = "Dica: compre um Amuleto na loja para ficar mais forte.";
      return;
    }
    toast("Ancião Lys: 'Zyland agradece. Continue treinando!'");
  }

  function merchantDialog(){
    toast("Mercadora Nia: 'Oi! Quer dar uma olhada nos meus itens?'");
    showShop();
  }

  // =========================
  // Combate por turnos
  // =========================
  const ENEMIES = [
    {
      id:"slime", name:"Slime Neon", hp:[10,16], atk:[3,5], def:[0,1],
      xp:[6,10], gold:[4,8],
      desc:"Uma gosma brilhante que quica pelo chão."
    },
    {
      id:"bat", name:"Morcego Carmesim", hp:[12,18], atk:[4,6], def:[1,2],
      xp:[8,12], gold:[5,10],
      desc:"Rápido e irritante — cuidado com as garras."
    },
    {
      id:"wolf", name:"Lobo Sombrio", hp:[18,26], atk:[5,8], def:[2,3],
      xp:[12,18], gold:[9,15],
      desc:"Predador da floresta, olhos frios e famintos."
    }
  ];

  function canEncounter(){
    // encontro só fora da vila (tile 0/3) e não em tile 4
    const t = world.tile(state.player.x, state.player.y);
    return t===0 || t===3;
  }

  function startBattle(forcedEnemyId=null){
    if(state.battle) return;

    const base = forcedEnemyId ? ENEMIES.find(e=>e.id===forcedEnemyId) : pick(ENEMIES);
    const e = JSON.parse(JSON.stringify(base));
    e.hpMax = rand(e.hp[0], e.hp[1]); e.hp = e.hpMax;
    e.atkV = rand(e.atk[0], e.atk[1]);
    e.defV = rand(e.def[0], e.def[1]);
    e.xpV  = rand(e.xp[0], e.xp[1]);
    e.goldV= rand(e.gold[0], e.gold[1]);

    state.battle = { enemy: e, turn: "player" };
    ui.battleCard.style.display = "block";
    updateBattleUI();
    ui.battleLog.innerHTML = "";
    log(`Um(a) ${e.name} apareceu!`);
    toast(`Combate iniciado contra: ${e.name}`);
  }

  function endBattle(win){
    const b = state.battle;
    if(!b) return;
    const e = b.enemy;
    state.battle = null;
    ui.battleCard.style.display = "none";

    if(win){
      const p = state.player;
      p.gold += e.goldV;
      gainXP(e.xpV);

      // quest: wolf kills
      if(e.id==="wolf" && p.flags.questWolf && !p.flags.questWolfDone){
        p.flags.wolfKills = (p.flags.wolfKills||0) + 1;
        if(p.flags.wolfKills >= 3){
          p.flags.questWolfDone = true;
          toast("Missão atualizada: Lobos derrotados! Volte ao Ancião.");
          ui.objective.textContent = "Volte ao Ancião Lys na vila para pegar a recompensa.";
        } else {
          ui.objective.textContent = `Derrote 3 Lobos Sombrios (${p.flags.wolfKills}/3) e volte ao Ancião.`;
        }
      }

      AudioFX.win();
      toast(`Vitória! +${e.goldV} ouro, +${e.xpV} XP.`);
    } else {
      AudioFX.lose();
      toast("Você desmaiou... Voltou para a vila com HP restaurado parcialmente.");
      // penalidade leve
      const p = state.player;
      p.hp = Math.max(10, Math.floor(p.hpMax * 0.35));
      p.mp = Math.max(3, Math.floor(p.mpMax * 0.35));
      // teleporta para vila
      p.x = 11; p.y = 13;
    }
    updateUI();
    save();
  }

  function log(text){
    const el = document.createElement("div");
    el.textContent = text;
    ui.battleLog.appendChild(el);
    ui.battleLog.scrollTop = ui.battleLog.scrollHeight;
  }

  function updateBattleUI(){
    const b = state.battle;
    if(!b) return;
    ui.enemyName.textContent = b.enemy.name;
    ui.enemyDesc.textContent = b.enemy.desc;
    ui.enemyHP.textContent = `HP: ${b.enemy.hp}/${b.enemy.hpMax}`;
  }

  function playerAttack(mult=1){
    const p = state.player;
    const b = state.battle;
    if(!b) return;
    const e = b.enemy;

    const base = p.atk + rand(-1,2);
    const dmg = Math.max(1, Math.floor((base * mult) - e.defV));
    e.hp = clamp(e.hp - dmg, 0, e.hpMax);
    AudioFX.hit();
    log(`Você atacou! -${dmg} HP no ${e.name}.`);
    updateBattleUI();
    checkBattleEndOrEnemyTurn();
  }

  function enemyTurn(){
    const p = state.player;
    const b = state.battle;
    if(!b) return;
    const e = b.enemy;

    const base = e.atkV + rand(-1,2);
    const dmg = Math.max(1, base - p.def);
    p.hp = clamp(p.hp - dmg, 0, p.hpMax);
    AudioFX.hit();
    log(`${e.name} atacou! Você perdeu ${dmg} HP.`);
    updateBattleUI();
    updateUI();

    if(p.hp<=0) endBattle(false);
  }

  function checkBattleEndOrEnemyTurn(){
    const p = state.player;
    const b = state.battle;
    if(!b) return;
    if(b.enemy.hp<=0){ endBattle(true); return; }

    // inimigo responde após pequena pausa
    setTimeout(()=>enemyTurn(), 450);
  }

  ui.bAttack.onclick = () => { AudioFX.click(); if(state.battle) playerAttack(1); };
  ui.bSkill.onclick = () => {
    AudioFX.click();
    const p = state.player;
    if(!state.battle) return;
    const cost = 4;
    if(p.mp < cost){
      log("Sem MP suficiente!");
      return;
    }
    p.mp -= cost;
    log("Você usou Golpe Arcano! (custa 4 MP)");
    playerAttack(1.6);
    updateUI();
  };
  ui.bItem.onclick = () => { AudioFX.click(); showInventory(); };
  ui.bRun.onclick = () => {
    AudioFX.click();
    if(!state.battle) return;
    const chance = 0.45 + (state.player.lv * 0.03);
    if(Math.random() < chance){
      log("Você conseguiu fugir!");
      toast("Você fugiu do combate.");
      state.battle = null;
      ui.battleCard.style.display = "none";
      updateUI();
      save();
    } else {
      log("Falhou ao fugir!");
      setTimeout(()=>enemyTurn(), 350);
    }
  };

  // =========================
  // XP / Level
  // =========================
  function gainXP(x){
    const p = state.player;
    p.xp += x;
    while(p.xp >= p.xpNeed){
      p.xp -= p.xpNeed;
      p.lv += 1;
      p.xpNeed = Math.floor(18 + p.lv * 9);

      // crescimento
      p.hpMax += 6 + Math.floor(p.lv/3);
      p.mpMax += 2 + (p.lv%2===0 ? 1 : 0);
      p.atk += 1 + (p.lv%2===0 ? 1 : 0);
      p.def += (p.lv%3===0 ? 1 : 0);

      p.hp = p.hpMax;
      p.mp = p.mpMax;

      AudioFX.win();
      toast(`LEVEL UP! Agora você é Lv ${p.lv}. HP/MP restaurados.`);
    }
    updateUI();
  }

  // =========================
  // Interação / Movimento
  // =========================
  const keys = new Set();
  window.addEventListener("keydown",(e)=>{
    const k = e.key;
    if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","w","a","s","d","W","A","S","D","Enter","e","E"].includes(k)){
      e.preventDefault();
    }
    keys.add(k);
    if(k==="Enter" || k==="e" || k==="E"){ interact(); }
  });
  window.addEventListener("keyup",(e)=>keys.delete(e.key));

  let moveCooldown = 0;

  function interact(){
    if(state.battle) return;
    // checar npc adjacente
    const p = state.player;
    for(const n of NPCS){
      const dist = Math.abs(n.x - p.x) + Math.abs(n.y - p.y);
      if(dist===1 || (n.x===p.x && n.y===p.y)){
        AudioFX.click();
        n.talk();
        updateUI();
        save();
        return;
      }
    }
    toast("Nada para interagir aqui.");
  }

  function tryMove(dx,dy){
    const p = state.player;
    const nx = p.x + dx, ny = p.y + dy;
    if(nx<0||ny<0||nx>=W||ny>=H) return;
    if(world.solid(nx,ny)) return;

    p.x = nx; p.y = ny;
    state.steps++;
    if(state.steps % 2 === 0) AudioFX.step();

    // encontros aleatórios fora da vila
    if(canEncounter()){
      const t = world.tile(p.x,p.y);
      // chance maior na grama
      const chance = (t===0 ? 0.11 : 0.06);
      if(Math.random() < chance){
        // se estiver na missão de lobos, mais chance de aparecer lobo na grama
        const f = p.flags;
        if(f.questWolf && !f.questWolfDone && Math.random() < 0.55){
          startBattle("wolf");
        } else {
          // peso por área: grama -> slime/bat/wolf
          const roll = Math.random();
          if(roll < 0.50) startBattle("slime");
          else if(roll < 0.85) startBattle("bat");
          else startBattle("wolf");
        }
      }
    }
  }

  // =========================
  // Render
  // =========================
  function updateUI(){
    const p = state.player;
    ui.pName.textContent = p.name;
    ui.pClass.textContent = `Classe: ${p.cls} • Região: Zyland`;
    ui.pLv.textContent = p.lv;

    ui.pHpTxt.textContent = p.hp; ui.pHpMax.textContent = p.hpMax;
    ui.pMpTxt.textContent = p.mp; ui.pMpMax.textContent = p.mpMax;
    ui.pXpTxt.textContent = p.xp; ui.pXpNeed.textContent = p.xpNeed;

    ui.pGold.textContent = p.gold;
    ui.pPot.textContent = p.inv.potion;

    ui.hpBar.style.width = (p.hp / p.hpMax * 100).toFixed(1) + "%";
    ui.mpBar.style.width = (p.mp / p.mpMax * 100).toFixed(1) + "%";
    ui.xpBar.style.width = (p.xp / p.xpNeed * 100).toFixed(1) + "%";

    if(!p.flags.metElder){
      ui.objective.textContent = "Encontre o Ancião na vila (✦) e fale com ele (E).";
      ui.hint.textContent = "A vila fica no centro. Procure o símbolo ✦.";
    } else if(p.flags.questWolf && !p.flags.questWolfDone){
      const k = p.flags.wolfKills || 0;
      ui.objective.textContent = `Derrote 3 Lobos Sombrios (${k}/3) e volte ao Ancião.`;
      ui.hint.textContent = "Lobos aparecem na grama (floresta).";
    } else if(p.flags.questWolfDone && !p.flags.questRewarded){
      ui.objective.textContent = "Volte ao Ancião Lys para pegar a recompensa.";
      ui.hint.textContent = "O Ancião está na vila (✦).";
    } else {
      ui.hint.textContent = "Explore, compre itens e evolua seu personagem!";
    }

    updateBattleUI();
  }

  function draw(){
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);
    ctx.save();
    ctx.scale(devicePixelRatio, devicePixelRatio);

    const gw = canvas.getBoundingClientRect().width;
    const gh = canvas.getBoundingClientRect().height;

    const scale = Math.min(gw/(W*TILE), gh/(H*TILE));
    const ox = (gw - W*TILE*scale)/2;
    const oy = (gh - H*TILE*scale)/2;

    ctx.translate(ox, oy);
    ctx.scale(scale, scale);

    // tiles
    for(let y=0;y<H;y++){
      for(let x=0;x<W;x++){
        const t = world.tile(x,y);
        // cores sem setar "estilo global", mas aqui é desenho
        if(t===0) ctx.fillStyle = "#0f2a1b";      // grama
        if(t===1) ctx.fillStyle = "#2a2a3a";      // rocha
        if(t===2) ctx.fillStyle = "#0b2a4a";      // água
        if(t===3) ctx.fillStyle = "#3a2f1a";      // areia
        if(t===4) ctx.fillStyle = "#2a1f3f";      // chão vila
        ctx.fillRect(x*TILE, y*TILE, TILE, TILE);

        // grid leve
        ctx.strokeStyle = "rgba(255,255,255,.03)";
        ctx.strokeRect(x*TILE, y*TILE, TILE, TILE);
      }
    }

    // NPCs
    for(const n of NPCS){
      // base
      ctx.fillStyle = "rgba(123,0,255,.15)";
      ctx.fillRect(n.x*TILE+4, n.y*TILE+4, TILE-8, TILE-8);
      ctx.strokeStyle = "rgba(0,224,255,.35)";
      ctx.strokeRect(n.x*TILE+4, n.y*TILE+4, TILE-8, TILE-8);

      ctx.fillStyle = "#e8e8ff";
      ctx.font = "16px system-ui,Segoe UI,Arial";
      ctx.fillText(n.icon, n.x*TILE + 11, n.y*TILE + 21);
    }

    // Player
    const p = state.player;
    // brilho
    const cxp = p.x*TILE + TILE/2;
    const cyp = p.y*TILE + TILE/2;
    const grad = ctx.createRadialGradient(cxp,cyp,2,cxp,cyp,18);
    grad.addColorStop(0,"rgba(0,224,255,.35)");
    grad.addColorStop(1,"rgba(123,0,255,0)");
    ctx.fillStyle = grad;
    ctx.beginPath(); ctx.arc(cxp,cyp,18,0,Math.PI*2); ctx.fill();

    ctx.fillStyle = "#00e0ff";
    ctx.fillRect(p.x*TILE+8, p.y*TILE+8, TILE-16, TILE-16);
    ctx.strokeStyle = "rgba(255,255,255,.35)";
    ctx.strokeRect(p.x*TILE+8, p.y*TILE+8, TILE-16, TILE-16);

    ctx.fillStyle = "#fff";
    ctx.font = "12px system-ui,Segoe UI,Arial";
    ctx.fillText("Você", p.x*TILE+6, p.y*TILE-2);

    // Se em combate, overlay discreto
    if(state.battle){
      ctx.fillStyle = "rgba(0,0,0,.25)";
      ctx.fillRect(0,0,W*TILE,H*TILE);
      // inimigo desenhado perto do player
      const e = state.battle.enemy;
      ctx.fillStyle = "rgba(255,77,109,.9)";
      ctx.fillRect((p.x+2)*TILE+10, (p.y-1)*TILE+10, TILE-12, TILE-12);
      ctx.fillStyle = "#fff";
      ctx.font = "12px system-ui";
      ctx.fillText(e.name, (p.x+2)*TILE, (p.y-1)*TILE-2);
    }

    ctx.restore();
  }

  // =========================
  // Loop
  // =========================
  function tick(dt){
    if(moveCooldown>0) moveCooldown -= dt;

    if(!state.battle && ui.modal.style.display!=="flex"){
      let dx=0,dy=0;
      if(keys.has("ArrowUp") || keys.has("w") || keys.has("W")) dy=-1;
      if(keys.has("ArrowDown") || keys.has("s") || keys.has("S")) dy=1;
      if(keys.has("ArrowLeft") || keys.has("a") || keys.has("A")) dx=-1;
      if(keys.has("ArrowRight") || keys.has("d") || keys.has("D")) dx=1;

      if((dx||dy) && moveCooldown<=0){
        tryMove(dx,dy);
        moveCooldown = 120; // ms
        updateUI();
        save();
      }
    }
    draw();
  }

  let last = performance.now();
  function loop(now){
    const dt = now - last; last = now;
    tick(dt);
    requestAnimationFrame(loop);
  }

  // =========================
  // Save/Load
  // =========================
  const SAVE_KEY = "zyrpg_save_v1";
  function save(){
    try{ localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }catch{}
  }
  function load(){
    try{
      const s = localStorage.getItem(SAVE_KEY);
      if(!s) return null;
      const obj = JSON.parse(s);
      return obj;
    }catch{ return null; }
  }

  // =========================
  // Inicialização
  // =========================
  updateUI();
  toast(state.msg || "Bem-vindo a Zyland!");
  requestAnimationFrame(loop);

})();
</script>
</body>
</html>
